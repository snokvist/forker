# Cleaned WFB config for forker
# All options in [general] can be overridden per [instance] if needed.

[general]
# Comma-separated list of interfaces that WFB-ng should use
wfb_nics=wlx40a5ef2f229b

# Preferred TX interface (falls back to first in wfb_nics if empty)
wfb_tx=wlx40a5ef2f229b

# FEC and modem parameters
fec_n=12
fec_k=8
mcs=2

# Socket buffer sizes
tx_rcv_buf_size=2097152
rx_snd_buf_size=2097152

# Logging interval in ms
log_interval=1000

# WiFi / RF parameters (not all are used directly by forker yet)
wifi_channel=165
stbc=0
ldpc=0
bandwidth=20
wifi_region=US
wifi_txpower=1500
guard_interval=long

# WFB key
key_file=/etc/gs.key

# Default radio port (0 = let WFB use its internal default)
radio_port=0

# Optional SSE wrapper used per-instance when sse=yes.
# Leave sse_tail blank to disable SSE globally.
sse_tail=/usr/local/bin/sse_tail
sse_host=0.0.0.0
sse_base_port=18080

# Run-once hooks
init_cmd=./monitor.sh monitor $wfb_nics
init_cmd=./shaper.sh $wfb_nics 2 20
cleanup_cmd=./monitor.sh restore $wfb_nics
cleanup_cmd=./shaper.sh $wfb_nics clear

# ----------------------------------------------------------------------
# VIDEO DOWNLINK (RX) PATH
# ----------------------------------------------------------------------

[instance master-video-rx]
type=aggregator
direction=rx
# UDP output to local Display/Decoder
output=udp://192.168.2.20:5600
# Aggregator listen port for remote forwarders
input=127.0.0.1:5500
linkid=7669206
sse=yes

[instance video-fwd]
type=forwarder
direction=rx
# Forward radio RX to the master-video-rx aggregator (above)
output=127.0.0.1:5500
linkid=7669206
radio_port=0
sse=no

# ----------------------------------------------------------------------
# VIDEO UPLINK (TX) PATH
# ----------------------------------------------------------------------

# Local video distributor: accepts UDP from encoder and feeds the injector.
[instance master-video-tx]
type=distributor
direction=tx
# UDP input from a local encoder (e.g. gst-launch ... ! udpsink port=5601)
input=127.0.0.1:5601
# Distributor host list (host:port1,port2,...) consumed by the injector(s)
output=127.0.0.1:5300
control_port=4050
linkid=7669206
radio_port=96
frame_type=data
fec_n=12
fec_k=8
mcs=2
fwmark=30
qdisc=yes
sse=no

# Injector that hands the local video stream to the selected radio NIC.
[instance video-tx-local]
type=injector
direction=tx
inject_port=5300
linkid=7669206
sse=no
fwmark=31
qdisc=yes


# ----------------------------------------------------------------------
# TUNNEL (L3) OVER WFB
# ----------------------------------------------------------------------

[instance tunnel]
type=tunnel
# wfb_tun parameters
ifname=gs-wfb
ifaddr=10.5.0.1/24
input_port=5450
output_port=5451
agg_timeout_ms=0
peer_address=127.0.0.1
sse=no

# RX side: WFB RX aggregator feeding the tunnel
[instance master-tunnel-rx]
type=aggregator
direction=rx
# Aggregator listen port for RX forwarders
input=127.0.0.1:5401
# Where to send packets so wfb_tun receives them
output=127.0.0.1:5450
linkid=7669206
radio_port=32
sse=no

# TX side: local TX that pulls packets from wfb_tun
[instance master-tunnel-tx]
type=distributor
direction=tx
# UDP input from wfb_tun back towards the radio link
input=127.0.0.1:5451
# Distributor host list (host:port1,port2,... per wfb_tx -d)
output=127.0.0.1:5400
control_port=4000
linkid=7669206
radio_port=160
sse=no
frame_type=rts
fec_n=2
fec_k=1
mcs=0
fwmark=20
qdisc=yes


# RX forwarder from radio into the tunnel aggregator
[instance tunnel-rx]
type=forwarder
direction=rx
# Forward radio RX into master-tunnel-rx (aggregator at 5401)
output=127.0.0.1:5401
linkid=7669206
radio_port=32
sse=no

# TX instance taking UDP from the tunnel aggregator and sending via radio
[instance tunnel-tx]
type=injector
inject_port=5400
direction=tx
# Injector pulls from inject_port; radio/NIC is chosen from wfb_tx or first wfb_nics
linkid=7669206
sse=no
fwmark=21
qdisc=yes
